<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weekly English Listening</title>
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:system-ui,sans-serif; margin:0; }
    header { padding:16px; border-bottom:1px solid #1f2937; background:#111827; position:sticky; top:0; }
    h1 { margin:0; font-size:20px; }
    .wrap { max-width:900px; margin:0 auto; padding:20px; }
    select,button { margin:4px; padding:6px 10px; border-radius:6px; border:1px solid #334155; background:#1e293b; color:#e5e7eb; }
    .line { padding:6px 0; border-bottom:1px dashed #334155; cursor:pointer; }
    .ko { color:#a5f3fc; font-size:14px; }
    .nav { display:flex; gap:12px; align-items:center; }
    .nav a { color:#38bdf8; text-decoration:none; font-size:14px; }
  </style>
</head>
<body>
<header>
  <div class="nav">
    <a href="index.html">← 데일리 브리핑으로</a>
    <h1>🎧 영어 리스닝 연습 (주간 업데이트 + 자동 번역)</h1>
  </div>
</header>

<div class="wrap">
  <div>
    <label>스토리 선택: </label>
    <select id="storySel"></select>
    <button onclick="playAll()">▶ 전체 재생</button>
  </div>
  <div>
    <label>보기 모드: </label>
    <button onclick="setViewMode('en')">영어만</button>
    <button onclick="setViewMode('line')">영어+한글</button>
    <button onclick="setViewMode('sep')">영어 따로/한글 따로</button>
  </div>
  <div style="margin:10px 0">
    <label>음성 선택: </label>
    <select id="voiceSel"></select>
    <label>속도: <input type="number" id="rate" value="1" step="0.1" style="width:60px"/></label>
  </div>
  <div id="scriptArea"></div>
</div>

<script>
let LIB = [];          // 전체 스토리 목록
let currentSet = null; // 현재 선택
let viewMode = 'line'; // 기본 보기 모드
let voices=[];

// ===== 무료 번역 =====
async function translateKo(text){
  try{
    const r=await fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ko&dt=t&q="+encodeURIComponent(text));
    const j=await r.json();
    return j[0].map(x=>x[0]).join('');
  }catch(e){ return ""; }
}

// ===== 렌더링 =====
async function renderScript(){
  if(!currentSet) return;
  let html='';
  if(viewMode==='en'){
    html = currentSet.lines.map((l,i)=>`<div class="line" onclick="playLine(${i})">${l.en}</div>`).join('');
  } else if(viewMode==='line'){
    html = (await Promise.all(current
