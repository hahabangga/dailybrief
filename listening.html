<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weekly English Listening</title>
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:system-ui,sans-serif; margin:0; }
    header { padding:16px; border-bottom:1px solid #1f2937; background:#111827; position:sticky; top:0; }
    h1 { margin:0; font-size:20px; }
    .wrap { max-width:900px; margin:0 auto; padding:20px; }
    select,button { margin:4px; padding:6px 10px; border-radius:6px; border:1px solid #334155; background:#1e293b; color:#e5e7eb; }
    .line { padding:6px 0; border-bottom:1px dashed #334155; cursor:pointer; }
    .ko { color:#a5f3fc; font-size:14px; }
    .nav { display:flex; gap:12px; align-items:center; }
    .nav a { color:#38bdf8; text-decoration:none; font-size:14px; }
  </style>
</head>
<body>
<header>
  <div class="nav">
    <a href="index.html">â† ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ìœ¼ë¡œ</a>
    <h1>ğŸ§ ì˜ì–´ ë¦¬ìŠ¤ë‹ ì—°ìŠµ (ì£¼ê°„ ì—…ë°ì´íŠ¸ + ìë™ ë²ˆì—­)</h1>
  </div>
</header>

<div class="wrap">
  <div>
    <label>ìŠ¤í† ë¦¬ ì„ íƒ: </label>
    <select id="storySel"></select>
    <button onclick="playAll()">â–¶ ì „ì²´ ì¬ìƒ</button>
  </div>
  <div>
    <label>ë³´ê¸° ëª¨ë“œ: </label>
    <button onclick="setViewMode('en')">ì˜ì–´ë§Œ</button>
    <button onclick="setViewMode('line')">ì˜ì–´+í•œê¸€</button>
    <button onclick="setViewMode('sep')">ì˜ì–´ ë”°ë¡œ/í•œê¸€ ë”°ë¡œ</button>
  </div>
  <div style="margin:10px 0">
    <label>ìŒì„± ì„ íƒ: </label>
    <select id="voiceSel"></select>
    <label>ì†ë„: <input type="number" id="rate" value="1" step="0.1" style="width:60px"/></label>
  </div>
  <div id="scriptArea"></div>
</div>

<script>
let LIB = [];          // ì „ì²´ ìŠ¤í† ë¦¬ ëª©ë¡
let currentSet = null; // í˜„ì¬ ì„ íƒ
let viewMode = 'line'; // ê¸°ë³¸ ë³´ê¸° ëª¨ë“œ
let voices=[];

// ===== ë¬´ë£Œ ë²ˆì—­ =====
async function translateKo(text){
  try{
    const r=await fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ko&dt=t&q="+encodeURIComponent(text));
    const j=await r.json();
    return j[0].map(x=>x[0]).join('');
  }catch(e){ return ""; }
}

// ===== ë Œë”ë§ =====
async function renderScript(){
  if(!currentSet) return;
  let html='';
  if(viewMode==='en'){
    html = currentSet.lines.map((l,i)=>`<div class="line" onclick="playLine(${i})">${l.en}</div>`).join('');
  } else if(viewMode==='line'){
    html = (await Promise.all(current
