<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>🎧 Listening – Daily Brief</title>
<link rel="icon" href="data:,">
<style>
  :root{ --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --sub:#91a4c7; --accent:#6aa0ff; --muted:#2a3450; }
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;line-height:1.6}
  header{padding:16px 12px;background:#0b1220;border-bottom:1px solid #1e2a44;position:sticky;top:0;z-index:5}
  .wrap{max-width:960px;margin:0 auto;padding:0 12px}
  h1{margin:0;font-size:22px}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  .meta{color:var(--sub);font-size:13px;margin-top:6px}
  .card{background:var(--card);border:1px solid var(--muted);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid #2f3b5a;border-radius:999px;padding:2px 8px;color:#b7c6e9;font-size:12px}
  .en{font-weight:600}
  .ko{color:#cfe1ff}
  .small{font-size:13px;color:#9fb0d6}
  .grid{display:grid;gap:12px}
  @media(min-width:860px){.grid{grid-template-columns:1.25fr 1fr}}
  ul{margin:8px 0 0;padding:0;list-style:none}
  li{padding:10px 0;border-top:1px solid #243252}
  li:first-child{border-top:0}
  .kws{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .err{color:#ffb3b3}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>🎧 Listening</h1>
    <div class="meta">
      <a href="./">← Daily Brief로 돌아가기</a> · <span id="updated">업데이트 시각: 로딩중…</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div id="episode" class="row">
        <div id="srcpill" class="pill">소스 불러오는 중…</div>
        <div id="pub" class="small">로딩 중…</div>
      </div>
      <h2 id="title" style="margin:8px 0 10px">제목 불러오는 중…</h2>
      <div class="row small">
        <a id="src" href="#" target="_blank">원문 링크</a>
      </div>
      <div style="margin-top:10px">
        <audio id="audio" controls preload="none" style="width:100%"></audio>
      </div>
      <div id="error" class="err small" style="margin-top:8px"></div>
    </section>

    <section class="card">
      <h3>🔑 핵심 단어(영영 뜻)</h3>
      <div id="keywords" class="kws"></div>
      <div id="kw-meanings" class="small" style="margin-top:8px"></div>
    </section>
  </div>

  <section class="card">
    <h3>📝 스크립트(EN → KO)</h3>
    <ul id="script"></ul>
  </section>
</main>

<script>
const $ = (q,root=document)=>root.querySelector(q);
const nowKST = new Date().toLocaleString('ko-KR',{timeZone:'Asia/Seoul'});
$('#updated').textContent = '업데이트 시각: ' + nowKST;

(async function(){
  try{
    const res = await fetch('data/listening.json?ts='+Date.now());
    if(!res.ok) throw new Error('listening.json 요청 실패: '+res.status);
    const j = await res.json();

    // 헤더
    $('#srcpill').textContent = j.source || 'Unknown';
    $('#title').textContent = j.episode_title || 'Untitled';
    $('#src').href = j.source_link || '#';
    $('#audio').src = j.audio_url || '';
    const pub = j.published_utc ? new Date(j.published_utc).toLocaleString('ko-KR', { timeZone:'Asia/Seoul' }) : '';
    $('#pub').textContent = pub ? `발행: ${pub} (KST 환산)` : '';

    // 키워드
    renderKeywords(j.keywords_en||[]);
    fetchMeanings(j.keywords_en||[]);

    // 스크립트
    const sents = (j.script_en||[]);
    const ul = $('#script'); ul.innerHTML='';
    if(!sents.length){
      $('#error').textContent = '⚠️ 스크립트가 비어있어요. 잠시 후 새로고침하거나, 상단 Actions에서 Fetch CNN listening을 수동 실행해보세요.';
    }
    for(const en of sents.slice(0,20)){
      const ko = await translateKo(en);  // 실패해도 영문은 표시
      const gram = detectGrammar(en);
      const li = document.createElement('li');
      li.innerHTML = `
        <div class="en">${escapeHtml(en)}</div>
        <div class="ko">${escapeHtml(ko||'(번역 실패: 원문 표시)')}</div>
        <div class="small">${gram ? '문법: '+escapeHtml(gram) : ''}</div>
      `;
      ul.appendChild(li);
    }
  }catch(e){
    $('#error').textContent = '⚠️ 데이터 로딩 실패: ' + e.message;
  }
})();

function renderKeywords(arr){
  const box = $('#keywords'); box.innerHTML='';
  (arr||[]).slice(0,8).forEach(w=>{
    const span = document.createElement('span');
    span.className='pill';
    span.textContent=w;
    box.appendChild(span);
  });
}

async function fetchMeanings(words){
  const out = [];
  for(const w of (words||[]).slice(0,6)){
    try{
      const r = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/'+encodeURIComponent(w));
      if(!r.ok) continue;
      const j = await r.json();
      const def = j?.[0]?.meanings?.[0]?.definitions?.[0]?.definition;
      if(def) out.push(`<b>${escapeHtml(w)}</b>: ${escapeHtml(def)}`);
    }catch(_){}
  }
  $('#kw-meanings').innerHTML = out.length? out.join('<br>'): '의미를 불러올 수 없어요.';
}

// 무료 번역(실패해도 원문 유지)
async function translateKo(text){
  try{
    const url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=ko&dt=t&q=' + encodeURIComponent(text);
    const j = await fetch(url).then(r=>r.json());
    return j[0].map(x=>x[0]).join('');
  }catch(e){
    return text;
  }
}

function detectGrammar(s){
  const t = s.toLowerCase();
  if(/\b(has|have|had)\s+been\s+\w+ing\b/.test(t)) return '완료진행형 (have/has been ~ing)';
  if(/\b(has|have|had)\s+\w+ed\b/.test(t)) return '현재/과거완료 (have/has + p.p.)';
  if(/\b(be|is|are|was|were)\s+\w+ed\b/.test(t)) return '수동태 (be + p.p.)';
  if(/\bif\b.+\b(will|would|could|might)\b/.test(t)) return '조건절(가정법/미래조건)';
  if(/\b(to|in order to)\s+\w+/.test(t)) return 'to부정사(목적)';
  if(/\bwhile\b|\bwhen\b/.test(t)) return '시간/대조 종속절 (while/when)';
  if(/\bthat\b.+\bsaid\b|\bsaid that\b/.test(t)) return '간접화법 (said that …)';
  return '';
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
</script>
</body>
</html>
