name: Nightly close fetch

on:
  schedule:
    # 매일 00:10 UTC (한국 09:10 KST)
    - cron: "10 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas

      - name: Fetch last closes with yfinance
        run: |
          python - << 'PY'
          import os, json
          from datetime import date
          import pandas as pd
          import yfinance as yf

          symbols = {
              '^GSPC': 'SPX',
              '^IXIC': 'IXIC',
              '^DJI':  'DJI',
              '^KS11': 'KOSPI',
          }

          values = {}
          last_dates = []
          for ysym, key in symbols.items():
              df = yf.download(ysym, period='14d', interval='1d', auto_adjust=False, progress=False)
              df = df.dropna()
              if df.empty:
                  continue
              last = df.iloc[-1]
              d = df.index[-1].date().isoformat()
              values[key] = round(float(last['Close']), 2)
              last_dates.append(d)

          out = {
              'date': max(last_dates) if last_dates else date.today().isoformat(),
              'values': values,
              'source': 'yfinance (Yahoo)'
          }

          os.makedirs('data', exist_ok=True)
          p = 'data/close.json'
          old = None
          if os.path.exists(p):
              try:
                  with open(p, 'r', encoding='utf-8') as f: old = json.load(f)
              except Exception:
                  pass
          with open(p, 'w', encoding='utf-8') as f:
              json.dump(out, f, ensure_ascii=False, indent=2)

          if old != out:
              print('UPDATED')
          else:
              print('NOCHANGE')
          PY

      - name: Commit & push if changed
        run: |
          if git diff --quiet data/close.json; then
            echo "No changes to commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/close.json
            git commit -m "chore(data): update closes [skip ci]"
            git push
          fi
