<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>데일리 브리핑</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; }
    body { margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; background:var(--bg); color:var(--text);}
    header { padding:16px; border-bottom:1px solid #1f2937; background:#111827; position:sticky; top:0; z-index:10;}
    .nav { display:flex; gap:12px; align-items:center; }
    .nav a { color:var(--accent); text-decoration:none; font-size:14px }
    h1 { margin:0; font-size:22px; }
    .wrap { max-width:1100px; margin:0 auto; padding:20px; display:grid; gap:20px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px;}
    .card h2 { margin:0 0 10px; font-size:18px;}
    .list { list-style:none; padding:0; margin:0;}
    .list li { padding:10px 0; border-bottom:1px dashed #334155;}
    .muted { color:var(--muted); font-size:13px;}
    .ko { color:#a5f3fc; font-size:13px; margin-top:4px;}
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0 0; }
    button, input { padding:6px 10px; border-radius:8px; border:1px solid #334155; background:#1e293b; color:#e5e7eb; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; color:#93c5fd; margin-right:6px;}
  </style>
</head>
<body>
<header>
  <div class="nav">
    <h1>데일리 브리핑</h1>
    <span style="flex:1"></span>
    <!-- 🎧 리스닝 링크 고정 -->
    <a href="listening.html" id="listeningLink">🎧 영어 리스닝</a>
  </div>
  <div id="todayStr" class="muted"></div>
</header>

<div class="wrap">
  <!-- 날씨 -->
  <section class="card">
    <h2>☀️ 오늘 날씨 & 7일 예보</h2>
    <div class="controls">
      <label>도시: <input id="city" value="Seoul"/></label>
      <button id="btnWeather">업데이트</button>
    </div>
    <div id="weatherNow" class="muted" style="margin-top:8px"></div>
    <ul id="weather7" class="list"></ul>
  </section>

  <!-- 운세 -->
  <section class="card">
    <h2>🔮 오늘의 운세 (1985-04-18)</h2>
    <div id="fortune"></div>
  </section>

  <!-- 종가 -->
  <section class="card">
    <h2>📊 전일 종가</h2>
    <div id="close" class="muted"></div>
  </section>

  <!-- 뉴스 헤더 -->
  <section class="card">
    <div style="display:flex; align-items:center; gap:10px;">
      <h2 style="margin:0">📰 오늘의 뉴스</h2>
      <span class="muted">(정치 · 경제 · 사회 · 국제)</span>
      <span style="flex:1"></span>
      <button id="toggleMode">요약 표시: 한글만</button>
    </div>
  </section>

  <!-- 뉴스 섹션 -->
  <section class="card"><h2>🏛️ 정치</h2><ul id="politics" class="list"></ul></section>
  <section class="card"><h2>💵 경제</h2><ul id="economy" class="list"></ul></section>
  <section class="card"><h2>👥 사회</h2><ul id="society" class="list"></ul></section>
  <section class="card"><h2>🌍 국제</h2><ul id="world" class="list"></ul></section>

  <!-- 종합 요약 & 시사점 -->
  <section class="card">
    <h2>📝 종합 요약</h2>
    <div id="wrapSummaryKo" class="ko" style="margin-bottom:6px"></div>
    <div id="wrapSummary" class="muted"></div>
    <h3 style="margin-top:12px">📈 미국 주식 투자 시사점</h3>
    <div id="investSummary"></div>
  </section>
</div>

<script>
// 공통
const $=q=>document.querySelector(q);
$('#todayStr').textContent=new Date().toLocaleString('ko-KR');

// 운세(간단 문구)
$('#fortune').textContent="오늘은 기회가 찾아올 수 있습니다. 새로운 도전을 두려워하지 마세요.";

// 종가
async function loadClose(){
  try{
    const j=await fetch('data/close.json?ts='+Date.now()).then(r=>r.json());
    $('#close').textContent=`S&P500 ${j.values.SPX}, NASDAQ ${j.values.IXIC}, 다우 ${j.values.DJI}, 코스피 ${j.values.KOSPI} (기준일: ${j.date})`;
  }catch(e){$('#close').textContent='데이터 없음';}
}
loadClose();

// 날씨
const weatherMap={0:"맑음",1:"대체로 맑음",2:"부분적으로 흐림",3:"흐림",45:"안개",48:"상층안개",
51:"이슬비 약함",53:"이슬비 보통",55:"이슬비 강함",61:"비 약함",63:"비 보통",65:"비 강함",
71:"눈 약함",73:"눈 보통",75:"눈 강함",80:"소나기 약함",81:"소나기 보통",82:"소나기 강함"};
async function loadWeather(city){
  try{
    const g=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=ko&format=json`).then(r=>r.json());
    const {latitude,longitude}=g.results[0];
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=Asia%2FSeoul`;
    const j=await fetch(url).then(r=>r.json());
    $('#weatherNow').textContent=`현재 ${j.current.temperature_2m}°C · ${weatherMap[j.current.weather_code]||''}`;
    $('#weather7').innerHTML=j.daily.time.map((t,i)=>
      `<li>${t}: ${j.daily.temperature_2m_max[i]}°/${j.daily.temperature_2m_min[i]}° · ${weatherMap[j.daily.weather_code[i]]||''}</li>`
    ).join('');
  }catch(e){$('#weatherNow').textContent='날씨 로딩 실패';}
}
$('#btnWeather').onclick=()=>loadWeather($('#city').value);
loadWeather('Seoul');

// ===== 무료 번역 함수 (google gtx) =====
async function translateKo(text){
  try{
    const r=await fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ko&dt=t&q="+encodeURIComponent(text));
    const j=await r.json();
    return j[0].map(x=>x[0]).join('');
  }catch(e){ return ""; }
}

// ===== 뉴스: 한글만 / 영어+한글 토글 =====
let showMode = 'ko'; // 'ko' | 'both'
$('#toggleMode').addEventListener('click', ()=>{
  showMode = (showMode==='ko' ? 'both' : 'ko');
  $('#toggleMode').textContent = '요약 표시: ' + (showMode==='ko' ? '한글만' : '영어+한글');
  loadNews(true);
});

async function renderItem(a){
  const en = a.summary || a.title || '';
  const ko = en ? await translateKo(en) : '';
  const whyKo = a.why_matters ? await translateKo(a.why_matters) : '';
  const nextKo = a.whats_next ? await translateKo(a.whats_next) : '';
  const kfig = (a.key_figures && a.key_figures.length) ? `<span class="badge">핵심 수치</span>${a.key_figures.join(', ')}` : '';

  return `
    <li>
      <a href="${a.url}" target="_blank">${a.title}</a>
      ${showMode==='both' && en ? `<div class="muted">${en}</div>`:''}
      ${ko ? `<div class="ko">${ko}</div>`:''}
      ${kfig ? `<div class="ko" style="margin-top:6px">${kfig}</div>`:''}
      ${whyKo ? `<div class="ko"><span class="badge">의미</span>${whyKo}</div>`:''}
      ${nextKo ? `<div class="ko"><span class="badge">다음</span>${nextKo}</div>`:''}
    </li>`;
}

async function renderList(id, arr){
  if(!arr) return;
  const htmlParts=[];
  for(const a of arr){
    htmlParts.push(await renderItem(a));
  }
  $(id).innerHTML=htmlParts.join('');
}

let cachedNews = null;
async function loadNews(force=false){
  try{
    if(!cachedNews || force){
      cachedNews = await fetch('data/news.json?ts='+Date.now()).then(r=>r.json());
    }
    const j=cachedNews;
    await renderList('#politics', j.sections.politics);
    await renderList('#economy', j.sections.economy);
    await renderList('#society', j.sections.society);
    await renderList('#world',   j.sections.world);

    // 종합 요약: 한국어 우선
    const wrapEn = j.wrap_summary || '';
    const wrapKo = wrapEn ? await translateKo(wrapEn) : '';
    $('#wrapSummaryKo').textContent = wrapKo || '요약을 불러올 수 없습니다.';
    $('#wrapSummary').textContent   = wrapEn ? `(영문) ${wrapEn}` : '';
    $('#investSummary').textContent = j.invest_summary || '';
  }catch(e){
    $('#wrapSummaryKo').textContent='뉴스 데이터 없음';
    $('#wrapSummary').textContent='';
  }
}
loadNews();
</script>
</body>
</html>
