<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Briefing</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; }
    * { box-sizing:border-box }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Helvetica, Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; background:var(--bg); color:var(--text); }
    header { padding:20px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.92)); backdrop-filter: blur(6px); z-index:10; }
    h1 { margin:0; font-size:22px; letter-spacing:.3px; }
    .sub { color:var(--muted); font-size:14px; margin-top:6px }
    .wrap { max-width:1100px; margin:0 auto; padding:22px; display:grid; grid-template-columns: 1fr; gap:18px }
    @media (min-width: 980px) { .wrap { grid-template-columns: 1.1fr 1fr; } }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px 16px 14px; box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    .card h2 { margin:0 0 10px; font-size:18px; }
    .row { display:flex; gap:10px; flex-wrap:wrap }
    .muted { color:var(--muted); font-size:13px }
    .kpi { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px }
    .kpi .tile { background:#0b1220; border:1px solid #1f2937; padding:10px 12px; border-radius:12px; }
    .tile .label { color:#9CA3AF; font-size:12px }
    .tile .value { font-size:16px; margin-top:4px }
    .list { list-style:none; padding:0; margin:0 }
    .list li { padding:8px 0; border-top:1px dashed #223046; }
    .list li:first-child { border-top:none }
    a { color: var(--accent); text-decoration:none }
    .inputline { display:flex; gap:8px; align-items:center; margin-bottom:10px }
    input, select { background:#0b1220; color:var(--text); border:1px solid #223046; padding:8px 10px; border-radius:10px }
    button { background:#0ea5e9; color:white; border:0; padding:8px 12px; border-radius:10px; cursor:pointer }
    .foot { text-align:center; color:#778; font-size:12px; padding:14px }
    .tvwrap { border-radius:12px; overflow:hidden; border:1px solid #223046; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; color:#a5b4fc; }
    .grid2 { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px }
  </style>
</head>
<body>
<header>
  <h1>오늘의 브리핑</h1>
  <div class="sub" id="todayStr">로딩 중…</div>
</header>

<div class="wrap">
  <!-- Left column -->
  <section class="card">
    <h2>☀️ 오늘 날씨 & 7일 예보 <span class="pill">Open‑Meteo</span></h2>
    <div class="inputline">
      <label class="muted">도시</label>
      <input id="city" placeholder="예: Seoul" value="Seoul" />
      <button id="btnWeather">업데이트</button>
      <span class="muted">(무료 API, 키 필요 없음)</span>
    </div>
    <div id="weatherNow" class="row" style="gap:16px; align-items:baseline"></div>
    <ul id="weather7" class="list" style="margin-top:10px"></ul>
  </section>

  <section class="card">
    <h2>🔮 오늘의 운세 (1985‑04‑18 기준)</h2>
    <div class="inputline">
      <label class="muted">생일</label>
      <input id="birthday" type="date" />
      <button id="btnFortune">운세 보기</button>
      <span id="zodiacLabel" class="muted"></span>
    </div>
    <div id="fortune" style="font-size:15px; line-height:1.5"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h2>📊 전일 종가 (미국/한국) <span class="pill">옵션: Alpha Vantage 키</span></h2>
    <div class="muted" style="margin-bottom:8px">기본은 위젯(아래)으로 차트만 제공됩니다. 전일 종가 텍스트 표시는 API 키 필요(옵션). 키 미설정 시 안내 문구가 보입니다.</div>
    <div class="kpi">
      <div class="tile"><div class="label">S&P 500 (전일종가)</div><div class="value" id="spxClose">키 필요</div></div>
      <div class="tile"><div class="label">NASDAQ (전일종가)</div><div class="value" id="ixicClose">키 필요</div></div>
      <div class="tile"><div class="label">Dow Jones (전일종가)</div><div class="value" id="djiClose">키 필요</div></div>
      <div class="tile"><div class="label">KOSPI (전일종가)</div><div class="value" id="kospiClose">키 필요</div></div>
    </div>
    <div class="muted" id="closeDate" style="margin-top:6px"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h2>📈 지수 모니터 (미국/한국) <span class="pill">TradingView 위젯</span></h2>
    <div class="tvwrap">
      <!-- TradingView Widget BEGIN -->
      <div class="tradingview-widget-container" style="height:400px">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
        {
          "colorTheme": "dark",
          "dateRange": "1D",
          "showChart": true,
          "locale": "kr",
          "width": "100%",
          "height": "400",
          "largeChartUrl": "",
          "isTransparent": false,
          "showSymbolLogo": true,
          "plotLineColorGrowing": "#4ade80",
          "plotLineColorFalling": "#f87171",
          "gridLineColor": "rgba(255,255,255,0.06)",
          "scaleFontColor": "rgba(255,255,255,0.5)",
          "belowLineFillColorGrowing": "rgba(34,197,94,0.15)",
          "belowLineFillColorFalling": "rgba(248,113,113,0.15)",
          "symbolActiveColor": "rgba(56,189,248, 0.2)",
          "tabs": [
            {
              "title": "미국",
              "symbols": [
                {"s": "FOREXCOM:SPXUSD", "d": "S&P 500"},
                {"s": "NASDAQ:IXIC", "d": "NASDAQ"},
                {"s": "DJ:DJI", "d": "Dow Jones"}
              ]
            },
            {
              "title": "한국",
              "symbols": [
                {"s": "KRX:KOSPI", "d": "KOSPI"},
                {"s": "KRX:KOSDAQ", "d": "KOSDAQ"}
              ]
            }
          ]
        }
        </script>
      </div>
      <!-- TradingView Widget END -->
    </div>
  </section>

  <section class="card">
    <h2>🇺🇸 미국 증시 이슈 (헤드라인)</h2>
    <ul id="usStockNews" class="list"></ul>
    <div class="muted" style="margin-top:8px; font-size:12px">기본은 Google 뉴스 링크. NewsAPI 키를 넣으면 자동으로 최신 5건을 불러옵니다.</div>
  </section>

  <section class="card">
    <h2>💵 미국 경제 이슈 한줄 요약</h2>
    <ul id="usEconNews" class="list"></ul>
  </section>

  <section class="card">
    <h2>🏛️ 미국 정치 이슈 한줄 요약</h2>
    <ul id="usPolNews" class="list"></ul>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h2>📰 미국 종합 이슈 & 강평</h2>
    <p id="usWrapSummary" class="muted" style="margin-bottom:8px">헤드라인을 바탕으로 자동 요약(제목 결합) 또는 수동 코멘트를 입력하세요.</p>
    <div class="inputline">
      <input id="manualComment" placeholder="여기에 오늘의 강평을 적어두면 로컬 저장됩니다." style="flex:1"/>
      <button id="saveComment">저장</button>
    </div>
    <div id="commentSaved" class="muted"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h2>🌍 세계 이슈 (전쟁·정치·연예 등)</h2>
    <ul id="worldNews" class="list"></ul>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h2>🗣️ 영어 한마디 (문장·번역·문법·단어)</h2>
    <div id="engOne" class="list"></div>
  </section>
</div>

<footer class="foot">© <span id="year"></span> Daily Briefing — 클라이언트 사이드만 사용(무료). 필요 시 API 키를 추가해 자동화 강화.</footer>

<script>
// ====== 기본 설정 ======
const CONFIG = {
  // 위치 기본값 (서울)
  cityDefault: 'Seoul',
  // 좌표 캐시 (간단 지오코딩)
  geoCache: {},
  // NewsAPI.org 키 (선택, 없으면 RSS 링크로 대체)
  NEWSAPI_KEY: '', // ← 있으면 넣으세요
  // Alpha Vantage 키 (선택: 전일 종가 텍스트용)
  ALPHA_KEY: '', // ← 있으면 넣으세요
  // 생일 (운세용)
  birthday: '1985-04-18'
};

// ====== 유틸 ======
const $ = (q) => document.querySelector(q);
const todayKST = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
$('#todayStr').textContent = `대한민국 표준시 — ${todayKST}`;
$('#year').textContent = new Date().getFullYear();

function fmtDate(d){
  return new Date(d).toLocaleDateString('ko-KR', { weekday:'short', month:'numeric', day:'numeric' });
}

// ====== 간단 지오코딩 (Open‑Meteo geocoding, 무키) ======
async function geocode(city){
  if(CONFIG.geoCache[city]) return CONFIG.geoCache[city];
  const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=ko&format=json`;
  const r = await fetch(url); const j = await r.json();
  if(!j.results || !j.results.length) throw new Error('도시를 찾을 수 없습니다');
  const { latitude, longitude, name, country } = j.results[0];
  CONFIG.geoCache[city] = { latitude, longitude, name, country };
  return CONFIG.geoCache[city];
}

// ====== 날씨 (Open‑Meteo, 무키) ======
async function loadWeather(city){
  try{
    const g = await geocode(city);
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${g.latitude}&longitude=${g.longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Asia%2FSeoul`;
    const r = await fetch(url); const j = await r.json();

    // 현재
    const wmap = {0:'맑음', 1:'대체로 맑음', 2:'부분 흐림', 3:'흐림', 45:'안개', 48:'서리 안개', 51:'가벼운 이슬비', 61:'가벼운 비', 63:'보통 비', 65:'강한 비', 71:'가벼운 눈', 73:'보통 눈', 75:'강한 눈', 80:'소나기', 95:'천둥번개'};
    const c = j.current;
    $('#weatherNow').innerHTML = `
      <div class="tile"><div class="label">지역</div><div class="value">${g.name} (${g.country})</div></div>
      <div class="tile"><div class="label">현재 기온</div><div class="value">${Math.round(c.temperature_2m)}°C</div></div>
      <div class="tile"><div class="label">체감</div><div class="value">${Math.round(c.apparent_temperature)}°C</div></div>
      <div class="tile"><div class="label">습도</div><div class="value">${c.relative_humidity_2m}%</div></div>
      <div class="tile"><div class="label">날씨</div><div class="value">${wmap[c.weather_code] ?? '—'}</div></div>
    `;

    // 7일
    const d = j.daily;
    const items = d.time.map((t, i) => {
      return `<li>${fmtDate(t)} — 최고 ${Math.round(d.temperature_2m_max[i])}° / 최저 ${Math.round(d.temperature_2m_min[i])}° · 강수 ${d.precipitation_sum[i]}mm · ${wmap[d.weather_code[i]] ?? ''}</li>`;
    }).join('');
    $('#weather7').innerHTML = items;
  }catch(e){ $('#weatherNow').textContent = '날씨 로딩 실패: ' + e.message }
}

$('#city').value = CONFIG.cityDefault;
$('#btnWeather').addEventListener('click', () => loadWeather($('#city').value.trim() || 'Seoul'));
loadWeather($('#city').value);

// ====== 운세 ======
function zodiacFromBirthday(ymd){
  const d = new Date(ymd);
  const m = d.getMonth()+1, day = d.getDate();
  const z = [
    ['capricorn',1,19,'염소자리'], ['aquarius',2,18,'물병자리'], ['pisces',3,20,'물고기자리'],
    ['aries',4,19,'양자리'], ['taurus',5,20,'황소자리'], ['gemini',6,21,'쌍둥이자리'],
    ['cancer',7,22,'게자리'], ['leo',8,22,'사자자리'], ['virgo',9,22,'처녀자리'],
    ['libra',10,22,'천칭자리'], ['scorpio',11,22,'전갈자리'], ['sagittarius',12,21,'사수자리'], ['capricorn',12,31,'염소자리']
  ];
  let name='capricorn', label='염소자리';
  for(const [k, mm, dd, lab] of z){ if(m<mm || (m===mm && day<=dd)){ name=k; label=lab; break; } }
  return { name, label };
}

function seededPick(list, seedStr){
  // 간단한 해시로 날짜+별자리 기반 결정적 선택
  let h=0; for(let i=0;i<seedStr.length;i++){ h = (h*31 + seedStr.charCodeAt(i))>>>0; }
  return list[h % list.length];
}

const fortunes = [
  '작은 선택이 큰 기회를 부릅니다.', '만남이 행운을 가져옵니다.', '정보가 힘입니다. 뉴스를 가까이 하세요.',
  '컨디션 조절에 신경 쓰면 성과가 큽니다.', '협업이 답입니다. 손을 내밀어 보세요.', '과감한 정리가 효율을 만듭니다.',
  '새로운 제안이 들어옵니다. 열린 마음으로.', '지출 관리에 신경 쓰면 수익이 커집니다.', '오늘의 키워드: 타이밍.'
];

function showFortune(){
  const b = CONFIG.birthday; // 고정 생일
  $('#birthday').value = CONFIG.birthday;
  const z = zodiacFromBirthday(b);
  $('#zodiacLabel').textContent = `(${z.label})`;
  const seed = new Date().toISOString().slice(0,10) + '|' + z.name; // 날짜+별자리
  $('#fortune').textContent = seededPick(fortunes, seed);
}
$('#btnFortune').addEventListener('click', showFortune);
showFortune();

// ====== 뉴스 (기본: 링크 / 옵션: NewsAPI) ======
const googleNewsLinks = {
  usStock: [
    { t: '미국 증시 이슈 – Google 뉴스', u: 'https://news.google.com/search?q=US%20stock%20market&hl=en-US&gl=US&ceid=US:en' },
    { t: 'FOMC / 연준', u: 'https://news.google.com/search?q=FOMC%20Fed&hl=en-US&gl=US&ceid=US:en' },
    { t: 'NVIDIA / TSLA 실적', u: 'https://news.google.com/search?q=earnings%20NVIDIA%20TSLA&hl=en-US&gl=US&ceid=US:en' }
  ],
  usEconomy: [
    { t: '미국 경제 – Google 뉴스', u: 'https://news.google.com/search?q=US%20economy%20CPI%20jobs%20inflation&hl=en-US&gl=US&ceid=US:en' }
  ],
  usPolitics: [
    { t: '미국 정치 – Google 뉴스', u: 'https://news.google.com/search?q=US%20politics%20Congress%20White%20House&hl=en-US&gl=US&ceid=US:en' }
  ],
  world: [
    { t: '세계 이슈 – Google 뉴스', u: 'https://news.google.com/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRFZxYUdjU0FtVnVLQUFQAQ?hl=ko&gl=KR&ceid=KR:ko' }
  ]
};

function renderLinkList(elId, arr){ $(elId).innerHTML = arr.map(x=>`<li><a href="${x.u}" target="_blank" rel="noopener">${x.t}</a></li>`).join(''); }
renderLinkList('#usStockNews', googleNewsLinks.usStock);
renderLinkList('#usEconNews', googleNewsLinks.usEconomy);
renderLinkList('#usPolNews', googleNewsLinks.usPolitics);
renderLinkList('#worldNews', googleNewsLinks.world);

// 선택사항: NewsAPI가 있으면 실제 헤드라인 5건씩 불러오기
async function tryNewsApi(q, el){
  if(!CONFIG.NEWSAPI_KEY) return; // 키 없으면 패스
  try{
    const url = `https://newsapi.org/v2/everything?q=${encodeURIComponent(q)}&pageSize=5&language=en&sortBy=publishedAt&apiKey=${CONFIG.NEWSAPI_KEY}`;
    const r = await fetch(url); const j = await r.json();
    if(j.articles){
      el.innerHTML = j.articles.map(a => `<li><a href="${a.url}" target="_blank" rel="noopener">${a.title}</a> <span class="muted">— ${new Date(a.publishedAt).toLocaleString('ko-KR')}</span></li>`).join('');
    }
  }catch(e){ /* 무시: 링크 리스트가 이미 렌더됨 */ }
}
tryNewsApi('US stock market OR stocks', $('#usStockNews'));
tryNewsApi('US economy inflation jobs CPI PCE', $('#usEconNews'));
tryNewsApi('US politics Congress White House election', $('#usPolNews'));
tryNewsApi('global geopolitics war conflict entertainment', $('#worldNews'));

// 미국 종합 요약: 단순히 3개 섹션 제목 합쳐 한줄 요약 (가벼운 기본 로직)
function synthesizeSummary(){
  const pick = (ul)=>{ const li = ul.querySelector('li'); return li? li.textContent.replace(/\s+—.*/, '') : ''; };
  const s = pick($('#usStockNews'));
  const e = pick($('#usEconNews'));
  const p = pick($('#usPolNews'));
  const parts = [s,e,p].filter(Boolean);
  $('#usWrapSummary').textContent = parts.length ? `요약: ${parts.join(' · ')}` : '요약: 최신 헤드라인을 불러오세요.';
}
setTimeout(synthesizeSummary, 1000);

// 강평 로컬 저장
const KEY='dailybrief_comment_'+new Date().toISOString().slice(0,10);
$('#saveComment').addEventListener('click', ()=>{
  localStorage.setItem(KEY, $('#manualComment').value.trim());
  $('#commentSaved').textContent = '오늘 강평이 저장되었습니다 (이 브라우저에서만).';
});
$('#manualComment').value = localStorage.getItem(KEY)||'';

// ====== 전일 종가 (옵션: Alpha Vantage) ======
async function loadCloseIfKey(){
  if(!CONFIG.ALPHA_KEY){ return; }
  $('#spxClose').textContent = '로딩…';
  $('#ixicClose').textContent = '로딩…';
  $('#djiClose').textContent  = '로딩…';
  $('#kospiClose').textContent= '로딩…';
  const map = [
    { id:'#spxClose', sym:'^GSPC' },
    { id:'#ixicClose', sym:'^IXIC' },
    { id:'#djiClose',  sym:'^DJI'  },
    { id:'#kospiClose',sym:'^KS11' }
  ];
  // 비공식 심볼은 제공 안 될 수 있음. 실패 시 문구 유지.
  const fetchDaily = async (symbol)=>{
    const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${encodeURIComponent(symbol)}&apikey=${CONFIG.ALPHA_KEY}`;
    const r = await fetch(url); return r.json();
  };
  let dateShown = '';
  for(const it of map){
    try{
      const j = await fetchDaily(it.sym);
      const series = j['Time Series (Daily)'];
      if(series){
        const dates = Object.keys(series).sort().reverse();
        const d0 = dates[0];
        const close = series[d0]['4. close'];
        $(it.id).textContent = Number(close).toLocaleString('ko-KR');
        dateShown = d0;
      }
    }catch(_){ /* 무시 */ }
  }
  if(dateShown){ $('#closeDate').textContent = `기준일: ${dateShown}`; }
}
loadCloseIfKey();

// ====== 영어 한마디: 문장·번역·문법·단어 ======
const PHRASES = [
  { en: 'Keep your focus, and the rest will follow.', ko: '집중을 유지하면 나머지는 따라옵니다.', grammar: '명령문(주어 생략) + 등위접속사 and + 독립절.', vocab: [ ['focus','집중'], ['follow','따라오다'] ] },
  { en: 'Small steps compound into big gains.', ko: '작은 걸음이 큰 성과로 쌓입니다.', grammar: '주어＋동사＋전치사구. compound into: ~로 누적되다.', vocab: [ ['compound into','~로 누적되다'], ['gain','이익, 성과'] ] },
  { en: 'Make it simple, then make it better.', ko: '먼저 단순하게, 그다음 더 좋게 만드세요.', grammar: '연속된 명령문. then: 시간적 순서.', vocab: [ ['simple','단순한'], ['better','더 나은'] ] },
  { en: 'Preparation is the shortcut.', ko: '준비가 곧 지름길입니다.', grammar: '명사절 S + be 동사 + 보어.', vocab: [ ['preparation','준비'], ['shortcut','지름길'] ] },
  { en: 'Clarity beats speed when the stakes are high.', ko: '중요할수록 명확함이 속도를 이깁니다.', grammar: '부사절 when ~. 복합명사 stakes(중요도/판돈).', vocab: [ ['clarity','명확성'], ['stakes','중요도, 이해관계'] ] },
  { en: 'Consistency turns effort into results.', ko: '지속성이 노력을 결과로 바꿉니다.', grammar: '주어＋동사＋목적어＋전치사구.', vocab: [ ['consistency','지속성'], ['turn A into B','A를 B로 바꾸다'] ] },
  { en: 'Ask better questions to get better answers.', ko: '더 나은 답을 원한다면 더 나은 질문을 하세요.', grammar: '부정사구 목적(의도) 표현.', vocab: [ ['question','질문'], ['answer','답'] ] }
];

function renderPhrase(){
  const today = new Date().toISOString().slice(0,10);
  const pick = seededPick(PHRASES, today);
  const vocabHtml = pick.vocab.map(([w,m]) => `<li>• <b>${w}</b>: ${m}</li>`).join('');
  $('#engOne').innerHTML = `
    <div class="tile">
      <div style="font-size:16px"><b>EN</b> — ${pick.en}</div>
      <div class="muted" style="margin-top:6px"><b>KO</b> — ${pick.ko}</div>
      <div style="margin-top:10px">
        <div class="muted"><b>문법</b></div>
        <div>${pick.grammar}</div>
      </div>
      <div style="margin-top:10px">
        <div class="muted"><b>단어</b></div>
        <ul class="list" style="margin-top:6px">${vocabHtml}</ul>
      </div>
    </div>`;
}
renderPhrase();

</script>
</body>
</html>
